<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ta Ta Ta ã‚·ãƒ•ã‚©ãƒ³ã‚±ãƒ¼ã‚­ ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰</title>
<link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
<style>
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    background: #fff8f0;
    color: #4b2e05;
    padding: 16px;
    max-width: 480px;
    margin: auto;
  }
  h1 {
    text-align: center;
    margin-bottom: 24px;
    font-weight: 700;
  }
  #stamps {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
  }
  .stamp {
    width: 40px;
    height: 40px;
    line-height: 40px;
    border-radius: 8px;
    border: 2px solid #d2691e;
    font-size: 24px;
    color: #d2691e;
    text-align: center;
    user-select: none;
    background: #fff;
    box-shadow: 0 0 6px rgba(210,105,30,0.3);
  }
  .stamp.filled {
    background-color: #d2691e;
    color: white;
    box-shadow: 0 0 10px #d2691e;
  }
  #message {
    text-align: center;
    font-weight: 600;
    color: #a45100;
    margin-bottom: 20px;
    min-height: 28px;
  }
  #reader {
    width: 100%;
    max-width: 320px;
    margin: 0 auto 20px auto;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgb(0 0 0 / 0.15);
  }
  #manual-input {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 30px;
  }
  #manual-input input {
    flex: 1;
    padding: 10px 12px;
    border-radius: 6px;
    border: 2px solid #d2691e;
    font-size: 16px;
  }
  #manual-input button {
    background-color: #d2691e;
    border: none;
    color: white;
    padding: 10px 18px;
    font-weight: 600;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.25s ease;
  }
  #manual-input button:hover {
    background-color: #b55a15;
  }
  @media (max-width: 400px) {
    #manual-input {
      flex-direction: column;
    }
    #manual-input button {
      width: 100%;
    }
  }
</style>
</head>
<body>
  <h1>Ta Ta Ta ã‚·ãƒ•ã‚©ãƒ³ã‚±ãƒ¼ã‚­<br>ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰</h1>
  <div id="message"></div>
  <div id="stamps"></div>

  <div id="reader"></div>

  <div id="manual-input">
    <input type="text" id="token-input" placeholder="ã‚¹ã‚¿ãƒƒãƒ•ã‹ã‚‰ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" maxlength="8" />
    <button id="btn-apply">ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ </button>
  </div>

<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
<script>
  const MAX_STAMPS = 10;

  let stamps = parseInt(localStorage.getItem('tata_stamps') || '0', 10);

  const messageEl = document.getElementById('message');
  const stampsEl = document.getElementById('stamps');

  // ã‚¹ã‚¿ãƒ³ãƒ—ã®è¡¨ç¤ºæ›´æ–°
  function renderStamps() {
    stampsEl.innerHTML = '';
    for(let i = 1; i <= MAX_STAMPS; i++) {
      const div = document.createElement('div');
      div.className = 'stamp' + (i <= stamps ? ' filled' : '');
      div.textContent = i <= stamps ? 'â˜…' : i;
      stampsEl.appendChild(div);
    }
  }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°
  function updateMessage() {
    if(stamps >= MAX_STAMPS) {
      messageEl.textContent = 'ğŸ‰ ã‚¹ã‚¿ãƒ³ãƒ—10å€‹ã§ã‚±ãƒ¼ã‚­1ã¤ç„¡æ–™ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼';
    } else {
      messageEl.textContent = '';
    }
  }

  // ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å¢—ã‚„ã™
  function addStamp() {
    if(stamps < MAX_STAMPS) {
      stamps++;
      localStorage.setItem('tata_stamps', stamps);
      renderStamps();
      updateMessage();
    }
  }

  // ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼ï¼ˆç°¡å˜ã«ã€8æ¡ã®æ•°å­—ã§åˆè¨ˆãŒå¶æ•°ãªã‚‰OK ã¨ã‹ï¼‰
  function validateToken(token) {
    if(!/^\d{8}$/.test(token)) return false;
    // ç°¡å˜ãªãƒã‚§ãƒƒã‚¯ï¼šæ•°å­—8æ¡ã®åˆè¨ˆãŒå¶æ•°ãªã‚‰OK
    const sum = token.split('').reduce((acc,c) => acc + Number(c), 0);
    return sum % 2 === 0;
  }

  // QRã‚³ãƒ¼ãƒ‰æˆåŠŸæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
  function onScanSuccess(decodedText, decodedResult) {
    if(validateToken(decodedText)) {
      addStamp();
      messageEl.textContent = 'âœ… QRã‚³ãƒ¼ãƒ‰èªè¨¼æˆåŠŸï¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚’1ã¤è¿½åŠ ã—ã¾ã—ãŸã€‚';
    } else {
      messageEl.textContent = 'âŒ èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ã‚¿ãƒƒãƒ•ã‹ã‚‰æ­£ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’ã‚‚ã‚‰ã£ã¦ã­ã€‚';
    }
    // QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šã‚’åœæ­¢ã—ã¦ã€å†èµ·å‹•ã¯æ‰‹å‹•ã§
    html5QrcodeScanner.clear();
  }

  // QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šã®åˆæœŸåŒ–
  const html5QrcodeScanner = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(cameras => {
    if(cameras && cameras.length) {
      const cameraId = cameras[0].id;
      html5QrcodeScanner.start(
        cameraId,
        {
          fps: 10,
          qrbox: 250
        },
        onScanSuccess,
        (errorMessage) => {
          // å¤±æ•—ã¯ç„¡è¦–ã§OK
        }
      );
    } else {
      messageEl.textContent = 'ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ‰‹å‹•å…¥åŠ›ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚';
    }
  }).catch(err => {
    messageEl.textContent = 'ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•å…¥åŠ›ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚';
  });

  // æ‰‹å‹•å…¥åŠ›ã®å‡¦ç†
  document.getElementById('btn-apply').addEventListener('click', () => {
    const token = document.getElementById('token-input').value.trim();
    if(validateToken(token)) {
      addStamp();
      messageEl.textContent = 'âœ… ã‚³ãƒ¼ãƒ‰èªè¨¼æˆåŠŸï¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚’1ã¤è¿½åŠ ã—ã¾ã—ãŸã€‚';
      document.getElementById('token-input').value = '';
    } else {
      messageEl.textContent = 'âŒ ç„¡åŠ¹ãªã‚³ãƒ¼ãƒ‰ã§ã™ã€‚ã‚‚ã†ä¸€åº¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
    }
  });

  renderStamps();
  updateMessage();
</script>
</body>
</html>
